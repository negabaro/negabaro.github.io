「アプリケーションが壊れているのに検知できないテストコード」を書かないようにするための、べからず集

https://qiita.com/jnchito/items/133d9953e1e7214e5357

つっつきボイス:「jnchitoさんのテスト記事です」「こういう記事を書いたということは、アサーションのないテストとかを実際に目にしたんでしょうね…」

「『エラーを検出できないテストを書かない』、これやられるとテストの工数がまるまる無駄になってしまいますし😢」

「『〜ではないことだけをテストしない』、正常系と異常系を両方テストしないとたいてい見落としが発生しますね😇」「どんなに自明だと思っても両方書かないと」

「境界値テストはどこまでやるか悩ましいけど必要ならやらないと」「年齢だったらわざとマイナスの数値入れるとか😆」「まそこまでやるかどうかですが😆」

「『呼び出されないlet』もやめて欲しいヤツ: 使わないテストデータが残ってると消していいかどうかもわからなくて超ツラい😢」

「『絞り込みの甘いテスト』もあるある😆」「テストコードを書いたときはうまく動いていても、機能やテストを追加すると絞り込みが甘くなったりすることがたまにありますね☺️」「たとえばcountして数を確認するテストなんかは1種類だけ書いてもこういうのを検出できないことがあったりするので、2種類書いておけば片方だけ落ちて検出できたりとか」「ふむふむ」

「not系のテストは、気をつけないと必ずパスしちゃうテストにたまになったり😆」「『テストファーストは必須でない』もわかる！」「自分はTDDってそれほど好きじゃないんですけど、テストを失敗させれば少なくともそのテストが動いていることは確認できるので、これも同意ですね☺️」

「『DRYを追求しない』も大賛成」「DRYにされるとコードを足したり削ったりしにくい😭」「『ループ処理を使わず、愚直にユーザー名をベタ書きする』も賛成！」「テストコードは変にロジカルにしないで基本ベタに書きましょう🧐」「テストコードにリテラルがんがん書いてOK😋」

「カバレッジといえば、simplecovの設定ミスっててカバレッジがちょっと漏れてたりすることあった😆けど最近は見ないかな〜」「最近のRubyだとコードから行単位で情報取れたりするので精度上がってそう😋」「テストコードがあってもそれ自体が検証されてなくて後でメンテする人がかえって泥沼になった事件あった🤣」「テストが検証されてなかったとか普通思いませんし🤣」

「どのエントリも納得😋」「jnchitoさんは、こういう当たり前のことをみっちり書いてくれるのがとってもありがたい🙏」






---

# アサーション（エクスペクテーション）が1つもないテストを書かない
以下のようにアサーション（RSpecではエクスペクテーション）が1つもないテストを書いてはいけません。
何も検証していないので、結果がなんであれテストがパスしてしまいます。

```ruby
# NG!!
example 'ユーザー名が表示される' do
  visit users_path

  # このメソッドはtrue/falseを返すだけで、成功失敗を検証するメソッドではない
  # よって、結果がなんであれ常にパスする
  page.has_content? 'Alice'
end
```

テスティングフレームワークには専用のアサーションメソッドがあるはずなので、それを使いましょう。

```ruby
# OK
example 'ユーザー名が表示される' do
  visit users_path

  # expect + have_textを使えば、指定された文字列が見つからないときにテストが失敗する
  expect(page).to have_content 'Alice'
end
```


-----------

# 網羅性や境界値判定が不完全なテストを書かない
たとえば、次のような「ユーザーが大人かどうか」を判定するメソッドがあったとします。

class User
  # ...
  def adult?
    age >= 20
  end
end
このとき、以下のようにtrueを返す場合だけを検証するテストを書いて満足してはいけません。

# NG!!
example '20歳以上ならadult?メソッドはtrueを返す' do
  user = User.new(age: 20)
  # trueを返す場合しかテストしていない
  expect(user.adult?).to be true
end
なぜなら、このテストは以下のような実装になっていてもテストがパスしてしまうからです。

def adult?
  # 常にtrueでも上のテストはパスしてしまう！！
  true
end
次のように、falseを返す場合も必ずテストしましょう。

# OK
example '20歳以上ならadult?メソッドはtrueを返す' do
  user = User.new(age: 20)
  expect(user.adult?).to be true

  # falseを返す場合も必ずテストする
  user = User.new(age: 19)
  expect(user.adult?).to be false
end
また、境界値をきちんとテストすることも重要です。
先ほどのメソッドであれば「20歳以上が大人」という仕様なので、19歳と20歳の間が境界になります。
ですので、先ほどのテストコードのように19歳のときと20歳のときを検証するのが正解です。

以下のように5歳と50歳を検証するようなテストコードだと、6歳から49歳のときにどういう結果になるか、テストで担保できません。


# NG!!
example '20歳以上ならadult?メソッドはtrueを返す' do
  # 境界値を正しくテストできていない（6歳から49歳のときに不具合が発生しうる）
  user = User.new(age: 50)
  expect(user.adult?).to be true
  user = User.new(age: 5)
  expect(user.adult?).to be false
end